SELECT
      opi.id,
      opi.order_created_date_kenya,
      o.original_delivery_date_kenya,
      opi.completed_date_kenya,
      opi.kyosk_id,
      kd.kyosk_code, 
      kd.kyosk_name,
      kd.duka_phone_numbers,
      sz.service_zone_code, 
      sz.service_zone_name,
      opi.order_code,
      opi.sale_code,
      opi.source_app,
      o.created_on_app,
      o.agent_name,
      case when o.agent_login = '34270825' then '28630155' else o.agent_login end as agent_login,
      o.agent_phone_number,
      opi.status,
      opi.boot_sale,
      opi.rescheduled,
      opi.cancel_reason,
      opi.cat_id,
      cat.catalog_sku,
      cat.catalog_name,
      cat.catalog_packaging,
      i.stocking_sku,
      i.stocking_name,
      i.stocking_unit,
      cat.conversion_ratio_from_catalog_to_inventory,
      opi.ordered_catalog_qty,
      opi.ordered_stocking_qty,
      opi.delivered_catalog_quantity,
      opi.delivered_stocking_quantity,
      opi.unit_sale_price_incl,
      opi.ordered_catalog_amount,
      opi.delivered_catalog_amount,
      opi.delivered_stocking_amount,
      opi.avg_cost_id,
      avgc.avg_unit_cost,
      avgc.avg_unit_cost_incl,
      (opi.delivered_catalog_quantity * avgc.avg_unit_cost_incl * cat.conversion_ratio_from_catalog_to_inventory) as total_cost_incl,
      opi.delivered_catalog_amount - (opi.delivered_catalog_quantity * avgc.avg_unit_cost_incl * cat.conversion_ratio_from_catalog_to_inventory) as gross_margin_incl,
      opi.drs_code,
      drs.drs_created_date,
      drs.drs_created_date_kenya,
      opi.dispatched_time,
      dispatched_time_kenya,
      date_diff(opi.dispatched_time_kenya, drs.drs_created_date_kenya, minute) as drs_dis_delta_min,
      date_diff(opi.completed_date_kenya, opi.dispatched_time_kenya, minute) as dispatch_to_order_completion_delta_min,
      drs.delivery_state,
      drs.dispatch_time,
      drs.driver_login,
      drs.driver_name,
      opi.delivery_delay,
      case when opi.delivery_delay is null then 'Cancelled' when opi.delivery_delay < 0 then 'Early' when opi.delivery_delay > 0 then 'Late' else  'On-Time' end as delivery_delay_status,
      opi.delivery_window_id,
      dw.delivery_window_start,
      case when dw.delivery_window_start = 8 then 'Morning Window' when dw.delivery_window_start = 13 then 'Afternoon Window' else 'Not Defined' end as delivery_window_status
FROM EXTERNAL_QUERY("projects/kyosk-prod/locations/europe-west4/connections/inventory_conn", 
'''SELECT id::text,
          date(order_created_date at time zone 'utc' at time zone 'Africa/Nairobi') as order_created_date_kenya,
          completed_date at time zone 'utc' at time zone 'Africa/Nairobi' as completed_date_kenya,
          dispatched_time,
          dispatched_time at time zone 'utc' at time zone 'Africa/Nairobi' as dispatched_time_kenya,
          kyosk_id::text,
          zone_id::text,
          order_code,
          source_app,
          status,
          rescheduled,
          boot_sale,
          cancel_reason,
          cat_id::text,
          inv_id::text,
          stocking_qty,
          final_stocking_qty,
          unit_sale_price_incl,
          catalog_qty as ordered_catalog_qty,
          stocking_qty as ordered_stocking_qty,
          final_catalog_qty as delivered_catalog_quantity,
          final_stocking_qty as delivered_stocking_quantity,
          unit_sale_price_incl  * catalog_qty as ordered_catalog_amount,
          unit_sale_price_incl * final_catalog_qty as delivered_catalog_amount,
          unit_sale_price_incl * final_stocking_qty as delivered_stocking_amount,
          sale_detail ->> 'saleCode' as sale_code,
          sales_tariff_id::text,
          avg_cost_id::text,
          drs_id::text,
          drs_code,
          delivery_window -> 'windowId' as delivery_window_id,
          delivery_delay
       FROM ops_item''') opi
left join EXTERNAL_QUERY("projects/kyosk-prod/locations/europe-west4/connections/inventory_conn", 
'''SELECT id::text,
          name as catalog_name,
          packaging as catalog_packaging, 
          sku as catalog_sku, 
          zone_code as service_zone_code,
          conversion_ratio_from_catalog_to_inventory,
          inv_id::text
       FROM catalog''') cat on opi.cat_id = cat.id
left join EXTERNAL_QUERY("projects/kyosk-prod/locations/europe-west4/connections/inventory_conn", 
'''SELECT id::text,
          code as kyosk_code, 
          name as kyosk_name, 
          phone_numbers as duka_phone_numbers
       FROM kyosk_duka''') kd on opi.kyosk_id = kd.id
left join EXTERNAL_QUERY("projects/kyosk-prod/locations/europe-west4/connections/inventory_conn", 
'''SELECT id::text,
          code as service_zone_code, 
          name as service_zone_name
       FROM service_zone''') sz  on opi.zone_id = sz.id
left join EXTERNAL_QUERY("projects/kyosk-prod/locations/europe-west4/connections/sale_conn", 
'''SELECT id::text,
          date(delivery_date at time zone 'utc' at time zone 'Africa/Nairobi') as original_Delivery_date_kenya,
          code as order_code,
          created_on_app,
          kyosk_agent ->> 'login' as agent_login,
          kyosk_agent ->> 'name' as agent_name,
          kyosk_agent ->> 'phoneNumber' as agent_phone_number
       FROM orders''') o on opi.order_code = o.order_code
left join EXTERNAL_QUERY("projects/kyosk-prod/locations/europe-west4/connections/inventory_conn", 
'''SELECT id::text,
          zone_id::text,
          created_date as drs_created_date,
          created_date at time zone 'utc' at time zone 'Africa/Nairobi' as drs_created_date_kenya,
          dispatch_time,
          code as drs_code, 
          delivery_state,
          driver ->> 'name' as driver_name,
          driver ->> 'login' as driver_login                                   
       FROM delivery_run_sheet''') drs on  opi.drs_code = drs.drs_code and opi.zone_id = drs.zone_id
left join EXTERNAL_QUERY("projects/kyosk-prod/locations/europe-west4/connections/sale_conn", 
'''SELECT id::text,
          start as delivery_window_start
       FROM delivery_window''') dw on opi.delivery_window_id = dw.id
left join EXTERNAL_QUERY("projects/kyosk-prod/locations/europe-west4/connections/inventory_conn", 
'''SELECT id::text,
          avg_unit_cost,
          avg_unit_cost_incl
       FROM avg_cost''') avgc on opi.avg_cost_id = avgc.id
left join EXTERNAL_QUERY("projects/kyosk-prod/locations/europe-west4/connections/inventory_conn", 
'''SELECT id::text,
          sku as stocking_sku,
          name as stocking_name,
          stocking_unit
       FROM inventory''') i on cat.inv_id = i.id