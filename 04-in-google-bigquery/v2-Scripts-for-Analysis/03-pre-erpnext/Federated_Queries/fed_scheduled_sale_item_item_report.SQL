select opi.id,
       opi.completed_date_kenya,
       sz.service_zone_code,
       sz.service_zone_name,
       cat.catalog_sku,
       cat.catalog_name,
       cat.catalog_packaging,
       opi.status,
       opi.sale_code,
       opi.order_code,
       sum(opi.delivered_catalog_amount) as delivered_catalog_amount,
       si.delivery_accounting,
       cast(si.catalog_qty as float64) as catalog_qty,
       cast(si.total_vat_amount as float64) as total_vat_amount,
       cast(si.unit_cost_without_vat as float64) as unit_cost_without_vat,
       cast(si.unit_cost_with_vat as float64) as unit_cost_with_vat,
       cast(si.total_cost_without_vat as float64) as total_cost_without_vat,
       cast(si.total_cost_with_vat as float64) as total_cost_with_vat,
       cast(si.discount_rate as float64) as discount_rate,
       cast(si.unit_discount_amount as float64) as unit_discount_amount,
       cast(si.total_discount_amount as float64) as total_discount_amount,
FROM EXTERNAL_QUERY("projects/kyosk-prod/locations/europe-west4/connections/inventory_conn", 
'''SELECT id::text,
          date(completed_date at time zone 'utc' at time zone 'Africa/Nairobi') as completed_date_kenya,
          kyosk_id::text,
          zone_id::text,
          order_code,
          status,
          cat_id::text,
          unit_sale_price_incl,
          catalog_qty as ordered_catalog_qty,
          final_catalog_qty as delivered_catalog_quantity,
          unit_sale_price_incl  * catalog_qty as ordered_catalog_amount,
          unit_sale_price_incl * final_catalog_qty as delivered_catalog_amount,
          sale_detail ->> 'saleCode' as sale_code
       FROM ops_item where status = 'Completed' ''') opi
       
left join EXTERNAL_QUERY("projects/kyosk-prod/locations/europe-west4/connections/inventory_conn", 
'''SELECT id::text,
          name as catalog_name,
          packaging as catalog_packaging, 
          sku as catalog_sku, 
          zone_code as service_zone_code
       FROM catalog''') cat on opi.cat_id = cat.id
left join EXTERNAL_QUERY("projects/kyosk-prod/locations/europe-west4/connections/inventory_conn", 
'''SELECT id::text,
          code as service_zone_code,
          name as service_zone_name
       FROM service_zone''') sz  on opi.zone_id = sz.id
left join EXTERNAL_QUERY("projects/kyosk-prod/locations/europe-west4/connections/inventory_conn", 
'''SELECT id::text,
          ops_item_id::text,
          sale_code,
          delivery_accounting,
          delivery_accounting ->> 'qty' as catalog_qty,
          delivery_accounting ->> 'totalVatAmount' as total_vat_amount,
          delivery_accounting ->> 'unitCostWithoutVat' as unit_cost_without_vat,
          delivery_accounting ->> 'unitCostWithVat' as unit_cost_with_vat,
          delivery_accounting ->> 'totalCostWithoutVat' as total_cost_without_vat,
          delivery_accounting ->> 'totalCostWithVat' as total_cost_with_vat,
          delivery_accounting ->> 'discountRate' as discount_rate,
          delivery_accounting ->> 'unitDiscountAmount' as unit_discount_amount,
          delivery_accounting ->> 'totalDiscountAmount' as total_discount_amount
       FROM sale_item where status = 'COMPLETED' ''') si  on opi.id = si.ops_item_id  and opi.sale_code = si.sale_code
group by 1,2,3,4,5,6,7,8,9,10,12,13,14,15,16,17,18,19,20,21