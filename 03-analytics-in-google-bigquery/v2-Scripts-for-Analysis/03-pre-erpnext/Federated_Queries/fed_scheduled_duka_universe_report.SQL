select k.id,
       k.kyosk_code, 
       k.created_date_kenya,
       k.last_modified_date_kenya,
       k.created_on_app,
       k.last_updated_on_app,
       k.created_by_name,
       k.last_modified_by_name,
       k.kyosk_name,
       k.owner_login,
       k.owner_email,
       k.owner_phone_number,
       k.phone_numbers,
       k.agent_login,
       k.agent_name,
       k.has_smart_phone,
       k.match_status,
       k.db_status,
       min(o.created_date_kenya) as first_order_date,
       max(o.created_date_kenya) as last_order_date,
       current_date() as current_date,
       date_diff(date_trunc(current_date(),month), max(date_trunc(o.created_date_kenya,month)), month) as month_since_last_order,
       count(distinct(case when o.created_on_app = 'DukaApp' then order_code else null end)) as order_count_duka_app,
       count(distinct(case when o.created_on_app = 'AgentApp' then order_code else null end)) as order_count_agent_app,
       case 
            when date_diff(date_trunc(current_date(),month), max(date_trunc(o.created_date_kenya,month)), month) is null then 'Dormant' 
            when date_diff(date_trunc(current_date(),month), max(date_trunc(o.created_date_kenya,month)), month) <= 2 then 'Active' 
       else 'In-Active' end as active_status,
from EXTERNAL_QUERY("projects/kyosk-prod/locations/europe-west4/connections/sale_conn", 
'''SELECT id::text,
          created_date at time zone 'utc' at time zone 'Africa/Nairobi' as created_date_kenya,
          last_modified_date at time zone 'utc' at time zone 'Africa/Nairobi' as last_modified_date_kenya,
          created_on_app,
          last_updated_on_app,
          created_by_name,
          last_modified_by_name,
          code as kyosk_code,
          name as kyosk_name,
          owner ->> 'login' as owner_login,
          owner ->> 'email' as owner_email,
          owner ->> 'phoneNumber' as owner_phone_number,
          phone_numbers,
          agent ->> 'login' as agent_login,
          agent ->> 'name' as agent_name,
          status as db_status,
          has_smart_phone,
          match_status
       FROM kyosk''') k
left join EXTERNAL_QUERY("projects/kyosk-prod/locations/europe-west4/connections/sale_conn", 
'''SELECT kyosk_code,
          date(created_date at time zone 'utc' at time zone 'Africa/Nairobi') as created_date_kenya,
          code as order_code,
          created_on_app

  FROM orders where status = 'Completed' ''') o on k.kyosk_code = o.kyosk_code
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18